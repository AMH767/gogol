<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Parser Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        
        .console-container {
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-family: 'Fira Code', monospace;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        .console-header {
            background-color: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }
        
        .console-body {
            height: 500px;
            overflow-y: auto;
            padding: 16px;
            color: #c9d1d9;
            font-size: 13px;
            line-height: 1.6;
            scroll-behavior: smooth;
        }
        
        .console-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .console-body::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        .console-body::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        
        .log-entry {
            margin-bottom: 12px;
            border-left: 2px solid transparent;
            padding-left: 10px;
            animation: fadeIn 0.3s ease-out;
        }
        
        .log-info { border-left-color: #58a6ff; }
        .log-success { border-left-color: #3fb950; background: rgba(63, 185, 80, 0.05); padding: 8px 10px; border-radius: 4px; }
        .log-warning { border-left-color: #d29922; }
        .log-error { border-left-color: #f85149; }
        
        .org-card {
            margin-top: 4px;
            color: #8b949e;
        }
        
        .org-name { color: #58a6ff; font-weight: 500; font-size: 14px; }
        .org-detail { display: flex; align-items: flex-start; margin-top: 2px; }
        .org-detail i { width: 20px; margin-top: 4px; font-size: 12px; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dot-flashing {
            display: inline-block;
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #58a6ff;
            color: #58a6ff;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
            margin-left: 15px;
        }
        
        @keyframes dot-flashing {
            0% { background-color: #58a6ff; }
            50%, 100% { background-color: rgba(88, 166, 255, 0.2); }
        }
    </style>
</head>
<body class="bg-[#010409] text-[#c9d1d9] min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i class="fas fa-map-marker-alt text-white text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight">Google Maps Parser <span class="text-blue-500">Pro</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="statusBadge" class="hidden px-3 py-1 rounded-full text-xs font-medium bg-gray-800 border border-gray-700">
                    <span id="statusText">IDLE</span>
                </div>
                <a href="/history_view" class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-gray-800 border border-gray-700 hover:bg-gray-700 transition-colors">
                    <i class="fas fa-history text-blue-400"></i>
                    <span>–ò—Å—Ç–æ—Ä–∏—è: <span id="historyCount">0</span></span>
                </a>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Settings Panel -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-[#0d1117] border border-[#30363d] rounded-lg p-6">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-[#8b949e] mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞</h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-[#8b949e] mb-1">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
                                <input type="text" id="org_query" class="w-full bg-[#010409] border border-[#30363d] rounded-md p-2.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all" placeholder="–ù–∞–ø—Ä: Pizza">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-[#8b949e] mb-1">–ì–æ—Ä–æ–¥</label>
                                <input type="text" id="city_query" class="w-full bg-[#010409] border border-[#30363d] rounded-md p-2.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all" placeholder="–ù–∞–ø—Ä: New York">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-[#8b949e] mb-1">–†–µ–≥–∏–æ–Ω (gl)</label>
                                <select id="region" class="w-full bg-[#010409] border border-[#30363d] rounded-md p-2.5 text-sm outline-none">
                                    <option value="US">USA (US)</option>
                                    <option value="RU">Russia (RU)</option>
                                    <option value="KZ">Kazakhstan (KZ)</option>
                                    <option value="BY">Belarus (BY)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-[#8b949e] mb-1">–Ø–∑—ã–∫ (hl)</label>
                                <select id="lang" class="w-full bg-[#010409] border border-[#30363d] rounded-md p-2.5 text-sm outline-none">
                                    <option value="en">English (en)</option>
                                    <option value="ru">–†—É—Å—Å–∫–∏–π (ru)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-[#8b949e] mb-1">–õ–∏–º–∏—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</label>
                            <input type="number" id="many" value="20" class="w-full bg-[#010409] border border-[#30363d] rounded-md p-2.5 text-sm outline-none">
                        </div>

                        <div class="flex items-center gap-2 py-2">
                            <input type="checkbox" id="deepSearch" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <label for="deepSearch" class="text-xs text-[#8b949e]">–ì–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫ (–ø–æ —Ä–∞–π–æ–Ω–∞–º)</label>
                        </div>
                        
                        <button onclick="startParsing()" id="startBtn" class="w-full bg-[#238636] hover:bg-[#2ea043] text-white font-semibold py-2.5 rounded-md transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-play text-xs"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä
                        </button>
                        
                        <button id="downloadBtn" class="hidden w-full bg-[#21262d] hover:bg-[#30363d] border border-[#30363d] text-[#c9d1d9] font-semibold py-2.5 rounded-md transition-colors flex items-center justify-center gap-2" onclick="downloadResults()">
                            <i class="fas fa-file-excel text-green-500"></i> –°–∫–∞—á–∞—Ç—å Excel
                        </button>
                    </div>
                </div>

                <div class="bg-[#0d1117] border border-[#30363d] rounded-lg p-6">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-[#8b949e] mb-4">–ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs">
                            <span id="progressLabel">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-[#30363d] rounded-full h-1.5">
                            <div id="progressBar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-[#8b949e]">
                            <span>–°–æ–±—Ä–∞–Ω–æ: <span id="progressCount">0</span></span>
                            <span>–¶–µ–ª—å: <span id="totalCount">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Console Panel -->
            <div class="lg:col-span-2">
                <div class="console-container">
                    <div class="console-header">
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1.5">
                                <div class="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
                                <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
                                <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
                            </div>
                            <span class="text-[11px] text-[#8b949e] ml-2 uppercase font-bold">Terminal ‚Äî google-maps-parser</span>
                        </div>
                        <div id="activeIndicator" class="hidden flex items-center gap-2">
                            <span class="text-[10px] text-blue-400 animate-pulse">PROCESSING</span>
                            <div class="dot-flashing"></div>
                        </div>
                    </div>
                    <div id="logArea" class="console-body">
                        <div class="log-entry log-info">
                            <span class="text-[#8b949e] mr-2">[*]</span> –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä".
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let lastLogCount = 0;

        async function updateHistoryCount() {
            try {
                const response = await fetch('/history_count');
                const data = await response.json();
                document.getElementById('historyCount').innerText = data.count;
            } catch (e) {
                console.error('Error updating history count:', e);
            }
        }

        // Initial update
        updateHistoryCount();

        function formatLog(msg) {
            const timestamp = new Date().toLocaleTimeString();
            
            if (msg.includes('‚úÖ –°–ø–∞—Ä—Å–µ–Ω–æ:')) {
                const parts = msg.split('\n');
                const name = parts[1] || 'N/A';
                const address = parts[2] || 'üìç N/A';
                const phone = parts[3] || 'üìû N/A';
                const website = parts[4] || 'üåê N/A';
                
                return `
                    <div class="log-entry log-success">
                        <div class="org-name">${name}</div>
                        <div class="org-card">
                            <div class="org-detail"><i class="fas fa-map-marker-alt"></i> ${address.replace('üìç ', '')}</div>
                            <div class="org-detail"><i class="fas fa-phone"></i> ${phone.replace('üìû ', '')}</div>
                            <div class="org-detail"><i class="fas fa-globe"></i> ${website.replace('üåê ', '')}</div>
                        </div>
                    </div>
                `;
            }
            
            let type = 'info';
            let icon = '[*]';
            let color = '#8b949e';
            
            if (msg.includes('‚ùå')) { type = 'error'; icon = '[!]'; color = '#f85149'; }
            else if (msg.includes('‚ö†Ô∏è')) { type = 'warning'; icon = '[?]'; color = '#d29922'; }
            else if (msg.includes('üì°') || msg.includes('üöÄ')) { type = 'info'; icon = '[>]'; color = '#58a6ff'; }
            else if (msg.includes('‚úÖ')) { type = 'success'; icon = '[+]'; color = '#3fb950'; }
            
            return `
                <div class="log-entry log-${type}">
                    <span style="color: ${color}" class="mr-2">${icon}</span> ${msg}
                </div>
            `;
        }

        async function startParsing() {
            const org = document.getElementById('org_query').value;
            const city = document.getElementById('city_query').value;
            const query = `${org} ${city}`.trim();
            const many = document.getElementById('many').value;
            const region = document.getElementById('region').value;
            const lang = document.getElementById('lang').value;
            const deepSearch = document.getElementById('deepSearch').checked;
            
            if (!query) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å');

            // UI Reset
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add('opacity-50');
            document.getElementById('downloadBtn').classList.add('hidden');
            document.getElementById('statusBadge').classList.remove('hidden');
            document.getElementById('statusText').innerText = 'RUNNING';
            document.getElementById('activeIndicator').classList.remove('hidden');
            
            const logArea = document.getElementById('logArea');
            logArea.innerHTML = formatLog(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á–∏: ${query}...`);
            lastLogCount = 0;

            try {
                const response = await fetch('/parse', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({org, city, many, region, lang, deepSearch})
                });
                
                const data = await response.json();
                currentTaskId = data.task_id;
                checkStatus();
            } catch (e) {
                logArea.innerHTML += formatLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`);
                resetUI();
            }
        }

        function resetUI() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').classList.remove('opacity-50');
            document.getElementById('statusText').innerText = 'IDLE';
            document.getElementById('activeIndicator').classList.add('hidden');
            updateHistoryCount();
        }

        async function checkStatus() {
            if (!currentTaskId) return;

            try {
                const response = await fetch('/status/' + currentTaskId);
                const data = await response.json();

                document.getElementById('progressCount').innerText = data.progress;
                document.getElementById('totalCount').innerText = data.total;
                
                const percent = Math.min(Math.round((data.progress / data.total) * 100), 100);
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressPercent').innerText = percent + '%';
                document.getElementById('progressLabel').innerText = data.status === 'completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–ü–∞—Ä—Å–∏–Ω–≥...';

                const logArea = document.getElementById('logArea');
                if (data.logs.length > lastLogCount) {
                    for (let i = lastLogCount; i < data.logs.length; i++) {
                        logArea.innerHTML += formatLog(data.logs[i]);
                    }
                    lastLogCount = data.logs.length;
                    logArea.scrollTop = logArea.scrollHeight;
                    updateHistoryCount();
                }

                if (data.status === 'completed') {
                    document.getElementById('downloadBtn').classList.remove('hidden');
                    document.getElementById('statusText').innerText = 'COMPLETED';
                    resetUI();
                } else if (data.status === 'error') {
                    document.getElementById('statusText').innerText = 'ERROR';
                    resetUI();
                } else {
                    setTimeout(checkStatus, 1500);
                }
            } catch (e) {
                console.error(e);
                setTimeout(checkStatus, 3000);
            }
        }

        function downloadResults() {
            window.location.href = '/download/' + currentTaskId;
        }
    </script>
</body>
</html>
